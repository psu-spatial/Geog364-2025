<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Tutorial_LISA.knit</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="projectlab.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="in_GEOG364_FAQ.html">FAQs</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    YOUR LABS
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="in_GEOG364_Lab1.html">Lab 1: Basics</a>
    </li>
    <li>
      <a href="in_GEOG364_Lab2.html">Lab 2: Data summary</a>
    </li>
    <li>
      <a href="in_GEOG364_Lab4.html">Lab 4: Spatial Wrangling</a>
    </li>
    <li>
      <a href="in_GEOG364_Lab5.html">Lab 5: Moran's I</a>
    </li>
    <li>
      <a href="in_GEOG364_Lab6.html">Lab 6: LISA and regression</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Advanced Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Tutorial_CensusData.html">Getting Census Data</a>
    </li>
    <li>
      <a href="Tutorial_SpatWeights.html">Spatial Weights Matrices</a>
    </li>
    <li>
      <a href="Tutorial_Moran.html">Moran's I</a>
    </li>
    <li>
      <a href="Tutorial_LISA.html">LISA</a>
    </li>
    <li>
      <a href="Tutorial_Regression.html">Regression</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    TURTLES
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Turtle_tutorial.html">Tutorial</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 0px;
border-radius: 5px;
font-style: normal;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>
<style type="text/css">
#TOC {
  font-size: 11px;
  font-family: Arial;
}
</style>
<div id="tutorial-local-spatial-autocorrelation" class="section level1">
<h1>TUTORIAL Local Spatial Autocorrelation</h1>
<p>In this tutorial, I will to assess the relationship between the
number of people who earn over $75000 dollars and population density in
Chicago. We will practice two new techniques, LISA (local
auto-regression) to see if each variable is auto-correlated with itself,
then actual regression - to understand the relationship between the
two.</p>
<p>WORK THROUGH THIS TUTORIAL, then the actual lab uses a different
dataset.</p>
<p><br></p>
</div>
<div id="step-1-getting-the-data" class="section level1">
<h1>STEP 1 Getting the data</h1>
<div id="libraries-needed-for-this-tutorial." class="section level2">
<h2>Libraries needed for this tutorial.</h2>
<p>Make sure all of these libraries are at the top of your lab script in
a code chunk, and run the code chunk! If you run the code chunk and it
says a package is missing, either click “install” if the little yellow
bar appears at the top, or go to the Packages tab, and click Install to
go to the package ‘app store’.</p>
<div id="boxgreen">
<p>Remember to set the code chunk options to message=FALSE and
warning=FALSE! <br> E.g. switch to Source mode and make the top of the
code chunk to <code>{r,message=FALSE, warning=FALSE}</code></p>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(olsrr)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">library</span>(rmapshaper)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="fu">library</span>(spatialreg)</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="fu">library</span>(spatialEco)</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="fu">library</span>(spatstat)</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="fu">library</span>(sfdep)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="fu">library</span>(VIM)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
<p>Run the code chunk a few times and check there are no errors.</p>
<p><br><br></p>
</div>
<div id="download-the-example-data-for-chicago." class="section level2">
<h2>Download the example data for Chicago.</h2>
<p>First, I downloaded American Community Survey data for Illinois at a
<u><strong>census tract spatial scale</strong></u>. A census tract is
similar to a zip code, a much finer spatial scale than a county. The way
to do this is similar to Lab 5.</p>
<p><br></p>
<details>
<summary>
<strong>Code to load the example data</strong>
</summary>
<p><br></p>
<p>We can load your data from the census and tidy up, before
plotting</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># THIS WILL NOT WORK IF YOU DIDN&#39;T RUN YOUR API KEY CODE &amp; RESTART R-STUDIO LAST LAB</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># Download Illinois ACS data at census tract level for my chosen variables, using tidycensus</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>IL.Census.sf <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(<span class="at">geography =</span> <span class="st">&quot;tract&quot;</span>, </span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>                <span class="at">year =</span> <span class="dv">2017</span>,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>                <span class="at">variables =</span> <span class="fu">c</span>(<span class="at">total_pop   =</span> <span class="st">&quot;B05012_001&quot;</span>, <span class="co"># total population</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>                              <span class="at">income.gt75 =</span> <span class="st">&quot;B06010_011&quot;</span>), <span class="co"># number of people making &gt; 75000 USD</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>                <span class="at">state =</span> <span class="st">&quot;IL&quot;</span>,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                <span class="at">survey =</span> <span class="st">&quot;acs5&quot;</span>,</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>                <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>                <span class="at">output=</span><span class="st">&quot;wide&quot;</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>                <span class="at">cache_table =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><br></p>
<p>We also need to change the map projection. As we’re focusing on a
single city, lets us a local UTM projection, 26916. To find one for your
area, see</p>
<ul>
<li><a
href="https://mangomap.com/robertyoung/maps/69585/what-utm-zone-am-i-in-"
class="uri">https://mangomap.com/robertyoung/maps/69585/what-utm-zone-am-i-in-</a></li>
</ul>
<p>There’s also a great tutorial here on choosing the best one <a
href="https://source.opennews.org/articles/choosing-right-map-projection/"
class="uri">https://source.opennews.org/articles/choosing-right-map-projection/</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Change the map projection to Albers equal projection, </span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># then remove empty polygons (lakes etc) and fix any broken geometry</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>IL.Census.sf <span class="ot">&lt;-</span> IL.Census.sf <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>                <span class="fu">st_transform</span>(<span class="dv">26916</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>                <span class="fu">st_make_valid</span>()</span></code></pre></div>
<p><br></p>
<p>You can see the data summarized here. Each column ending in E means
the <em>estimate</em> of the value in each census tract and the column
ending in M means the <em>margin of error</em>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">head</span>(IL.Census.sf)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["GEOID"],"name":[1],"type":["chr"],"align":["left"]},{"label":["NAME"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_popE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["total_popM"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["income.gt75E"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["income.gt75M"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["geometry"],"name":[7],"type":["s_MULTIP"],"align":["right"]}],"data":[{"1":"17001000202","2":"Census Tract 2.02, Adams County, Illinois","3":"2473","4":"258","5":"92","6":"51","7":"<s_MULTIP>","_rn_":"1"},{"1":"17011965100","2":"Census Tract 9651, Bureau County, Illinois","3":"3898","4":"222","5":"275","6":"58","7":"<s_MULTIP>","_rn_":"2"},{"1":"17019000301","2":"Census Tract 3.01, Champaign County, Illinois","3":"4740","4":"548","5":"34","6":"44","7":"<s_MULTIP>","_rn_":"3"},{"1":"17019000700","2":"Census Tract 7, Champaign County, Illinois","3":"3528","4":"359","5":"79","6":"53","7":"<s_MULTIP>","_rn_":"4"},{"1":"17019001203","2":"Census Tract 12.03, Champaign County, Illinois","3":"4788","4":"362","5":"675","6":"176","7":"<s_MULTIP>","_rn_":"5"},{"1":"17019005800","2":"Census Tract 58, Champaign County, Illinois","3":"4013","4":"392","5":"576","6":"99","7":"<s_MULTIP>","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>For more advanced work we probably want to keep the error columns.
But here let’s remove them.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Remove and rename error columns </span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>IL.Census.sf <span class="ot">&lt;-</span> IL.Census.sf <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    GEOID, </span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    NAME,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="at">total_pop    =</span> total_popE, </span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    <span class="at">income.gt75  =</span> income.gt75E, </span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    geometry )</span></code></pre></div>
<p><br></p>
<p>Rather than looking at the total population, it makes sense to scale
by the size of each tract, so that bigger tracts don’t skew our results.
We want:</p>
<ul>
<li>the population density (e.g. total_pop / Area)<br></li>
<li>the percentage of people earning over $75K (e.g. income.gt75 /
total_pop)<br></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Find the areas in each county &amp; change the units from metres squared to km squared</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>IL.Census.sf<span class="sc">$</span>Area  <span class="ot">&lt;-</span> <span class="fu">st_area</span>(IL.Census.sf)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>IL.Census.sf<span class="sc">$</span>Area  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">set_units</span>(IL.Census.sf<span class="sc">$</span>Area,<span class="st">&quot;km^2&quot;</span>))</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># Divide the total population &amp; housing by the area to give the population/housing density</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>IL.Census.sf<span class="sc">$</span>pop.density_km2  <span class="ot">&lt;-</span> IL.Census.sf<span class="sc">$</span>total_pop   <span class="sc">/</span> IL.Census.sf<span class="sc">$</span>Area</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co"># Divide the total population &amp; housing by the area to give the population/housing density</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>IL.Census.sf<span class="sc">$</span>percent.income.gt75  <span class="ot">&lt;-</span> IL.Census.sf<span class="sc">$</span>income.gt75   <span class="sc">/</span> IL.Census.sf<span class="sc">$</span>total_pop</span></code></pre></div>
<p>Here is the summary of the data I downloaded with the new columns
added in. You can see that there are 3123 census tracts in Illinois and
that the data is clearly marked, with 8 columns of data.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">head</span>(IL.Census.sf)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["GEOID"],"name":[1],"type":["chr"],"align":["left"]},{"label":["NAME"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_pop"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["income.gt75"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["geometry"],"name":[5],"type":["s_POLYGO"],"align":["right"]},{"label":["Area"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["pop.density_km2"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["percent.income.gt75"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"17001000202","2":"Census Tract 2.02, Adams County, Illinois","3":"2473","4":"92","5":"<s_POLYGO>","6":"1.5197716","7":"1627.21822","8":"0.037201779","_rn_":"1"},{"1":"17011965100","2":"Census Tract 9651, Bureau County, Illinois","3":"3898","4":"275","5":"<s_POLYGO>","6":"45.6438871","7":"85.40026","8":"0.070548999","_rn_":"2"},{"1":"17019000301","2":"Census Tract 3.01, Champaign County, Illinois","3":"4740","4":"34","5":"<s_POLYGO>","6":"0.4560874","7":"10392.74423","8":"0.007172996","_rn_":"3"},{"1":"17019000700","2":"Census Tract 7, Champaign County, Illinois","3":"3528","4":"79","5":"<s_POLYGO>","6":"2.5906758","7":"1361.80685","8":"0.022392290","_rn_":"4"},{"1":"17019001203","2":"Census Tract 12.03, Champaign County, Illinois","3":"4788","4":"675","5":"<s_POLYGO>","6":"2.5860780","7":"1851.45227","8":"0.140977444","_rn_":"5"},{"1":"17019005800","2":"Census Tract 58, Champaign County, Illinois","3":"4013","4":"576","5":"<s_POLYGO>","6":"1.4473906","7":"2772.57577","8":"0.143533516","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</details>
<div class="small-gap">

</div>
<p><br> <br></p>
</div>
<div id="data-wrangling" class="section level2">
<h2>Data wrangling</h2>
<p><br></p>
<div id="dealing-with-empty-polygons" class="section level3">
<h3>Dealing with empty polygons</h3>
<p>One quirk of R is that it **hates* empty polygons so it’s good to
check for them. IF YOU GET ERRORS PLOTTING, I BET THIS IS WHAT IS
HAPPENING.</p>
<p>In our case, empty polygons means empty census tracts. These might be
census tracts where no-one lives, or more likely, a quirk of the data
collection process. Let’s take a look at them.</p>
<p><br></p>
<p>We can check this with the <code>st_is_empty()</code> command:</p>
<p><br></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># filter to just the empty tracts.</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">filter</span>(IL.Census.sf,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>       <span class="fu">st_is_empty</span>(IL.Census.sf))</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["GEOID"],"name":[1],"type":["chr"],"align":["left"]},{"label":["NAME"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_pop"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["income.gt75"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["geometry"],"name":[5],"type":["s_MULTIP"],"align":["right"]},{"label":["Area"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["pop.density_km2"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["percent.income.gt75"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"17097990000","2":"Census Tract 9900, Lake County, Illinois","3":"0","4":"0","5":"<s_MULTIP>","6":"0","7":"NaN","8":"NaN","_rn_":"1"},{"1":"17031990000","2":"Census Tract 9900, Cook County, Illinois","3":"0","4":"0","5":"<s_MULTIP>","6":"0","7":"NaN","8":"NaN","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p><br></p>
<p>OK so it’s tracts 9900 in Cook county and lake county Illinois. Let’s
google that… and the results suddenly make sense!</p>
<p><br></p>
<div class="figure">
<img src="index_images/pg_364Lab7_Regression_2021_fig3.png" alt="*https://censusreporter.org/profiles/14000US17031990000-census-tract-9900-cook-il/*" width="1383" />
<p class="caption">
<em><a
href="https://censusreporter.org/profiles/14000US17031990000-census-tract-9900-cook-il/"
class="uri">https://censusreporter.org/profiles/14000US17031990000-census-tract-9900-cook-il/</a></em>
</p>
</div>
<p><br></p>
<p>It’s the lake! I feel satisfied that removing these polygons won’t
mess up my study. So I’m going to go ahead and remove them and overwrite
the results. E.g. I apply the filter command to IL.Census.sf, asking it
to only choose rows where which_tracts_empty is FALSE, then save the
result to IL.Census.sf.</p>
<p><br></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>  IL.Census.sf <span class="ot">&lt;-</span> IL.Census.sf <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>                  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(geometry)) </span></code></pre></div>
<p><br></p>
<p>Now.. let’s try again. Yep, we have removed the empty fields.</p>
<p><br></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># filter to just the empty tracts.</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">filter</span>(IL.Census.sf,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>       <span class="fu">st_is_empty</span>(IL.Census.sf))</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["GEOID"],"name":[1],"type":["chr"],"align":["left"]},{"label":["NAME"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_pop"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["income.gt75"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["geometry"],"name":[5],"type":["s_GEOMET"],"align":["right"]},{"label":["Area"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["pop.density_km2"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["percent.income.gt75"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div id="quick-check" class="section level3">
<h3>Quick check</h3>
<p>I then had a quick look at the data in tmap to make sure it looked
good, using the code from previous labs.</p>
<p><br></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># create map 1</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>map1 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(IL.Census.sf, <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;income.gt75&quot;</span>,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="dv">0</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">&quot;pretty&quot;</span>,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>      <span class="at">values =</span> <span class="st">&quot;brewer.yl_gn_bu&quot;</span>,</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    )</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="fu">tm_title</span>(<span class="st">&quot;Number of people making $75K per census tract&quot;</span>, <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="at">frame =</span> <span class="cn">FALSE</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  )</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>map2 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(IL.Census.sf, <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;percent.income.gt75&quot;</span>,</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="dv">0</span>,</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">&quot;quantile&quot;</span>,</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>      <span class="at">values =</span> <span class="st">&quot;brewer.reds&quot;</span>,</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    )</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>  <span class="fu">tm_scalebar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">&quot;4star&quot;</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>  <span class="fu">tm_title</span>(<span class="st">&quot;Percentage of people making $75K per census tract&quot;</span>, <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>    <span class="at">frame =</span> <span class="cn">FALSE</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>  )</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">tmap_arrange</span>(map1,map2))</span></code></pre></div>
<p><img src="Tutorial_LISA_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p><br></p>
<p>and population density</p>
<p><br></p>
<p><img src="Tutorial_LISA_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p><br> <br></p>
</div>
<div id="cropping-to-chicago" class="section level3">
<h3>Cropping to Chicago</h3>
<p><br></p>
<p>This map looks at all of Illinois. But we want to look at the area
just around Chicago. Let’s crop to the city’s administrative boundaries.
We can download these using the <strong>Tigris package</strong>.</p>
<p><br></p>
<p>Tigris has <em>thousands</em> of boundary data-sets that you can
explore. For a tutorial, see here [<a
href="https://crd150.github.io/lab4.html#tigris_package"
class="uri">https://crd150.github.io/lab4.html#tigris_package</a>] and
here [<a href="https://github.com/walkerke/tigris"
class="uri">https://github.com/walkerke/tigris</a>]</p>
<p><br></p>
<p>For now, lets download the Chicago metropolitan area data then select
Chicago</p>
<div id="boxgreen">
<p>FOR THIS CODE CHUNK, set results=FALSE as a codechunk option, or it
will swamp your knit: <br> <code>{r, results=FALSE}</code></p>
</div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>cb.sf            <span class="ot">&lt;-</span> <span class="fu">core_based_statistical_areas</span>(<span class="at">cb =</span> <span class="cn">TRUE</span>, <span class="at">year=</span><span class="dv">2017</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>Chicago.city.sf  <span class="ot">&lt;-</span> <span class="fu">filter</span>(cb.sf, <span class="fu">grepl</span>(<span class="st">&quot;Chicago&quot;</span>, NAME))</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># and set the projection to be identical to the census data</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>Chicago.city.sf  <span class="ot">&lt;-</span> Chicago.city.sf <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                    <span class="fu">st_transform</span>(<span class="dv">26916</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                    <span class="fu">st_make_valid</span>()</span></code></pre></div>
<p><br></p>
<p><br></p>
<p>and, just so you can see what I have done..</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>map.city <span class="ot">&lt;-</span> <span class="fu">qtm</span>(<span class="fu">st_geometry</span>(Chicago.city.sf),<span class="at">fill =</span> <span class="cn">NULL</span>,<span class="at">border=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>map.city</span></code></pre></div>
<p><br> <br></p>
<p>We can now crop our census data to this specific area using the
<code>ms_clip</code> function.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># subset the Illinois census data with the Chicago city limits</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>Chicago.Census.sf <span class="ot">&lt;-</span> <span class="fu">ms_clip</span>(<span class="at">target =</span> IL.Census.sf, </span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>                             <span class="at">clip =</span> Chicago.city.sf, </span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>                             <span class="at">remove_slivers =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Let’s remake that map, remember to play with the style option if your
color scale isn’t useful</p>
<p><br></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># create map 1</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>map2 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(Chicago.Census.sf, <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;percent.income.gt75&quot;</span>,</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="dv">0</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">&quot;quantile&quot;</span>,</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="at">values =</span> <span class="st">&quot;brewer.reds&quot;</span>,</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    )</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="fu">tm_shape</span>(<span class="fu">st_geometry</span>(Chicago.city.sf), <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="fu">tm_borders</span>()<span class="sc">+</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  <span class="fu">tm_scalebar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">&quot;4star&quot;</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>  <span class="fu">tm_title</span>(<span class="st">&quot;Percentage of people making $75K per census tract&quot;</span>, <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>    <span class="at">frame =</span> <span class="cn">FALSE</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  )</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#and</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>map4 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(Chicago.Census.sf, <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;pop.density_km2&quot;</span>,</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="dv">0</span>,</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">&quot;quantile&quot;</span>,</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>      <span class="at">values =</span> <span class="st">&quot;brewer.purples&quot;</span>,</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>     <span class="fu">tm_shape</span>(<span class="fu">st_geometry</span>(Chicago.city.sf), <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>  <span class="fu">tm_borders</span>()<span class="sc">+</span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a>  <span class="fu">tm_scalebar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">&quot;4star&quot;</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a>  <span class="fu">tm_title</span>(<span class="st">&quot;Population density&quot;</span>, <span class="at">size =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a>    <span class="at">frame =</span> <span class="cn">FALSE</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a>  )</span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="co"># and print</span></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">tmap_arrange</span>(map2,map4))</span></code></pre></div>
<p><img src="Tutorial_LISA_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p><br> <br></p>
</div>
</div>
</div>
<div id="step-2-autocorrelation" class="section level1">
<h1>STEP 2 Autocorrelation</h1>
<p>Here we are going to look BOTH at global Moran’s I and its local
equivalent, LISA. Because it builds directly on your previous lab, I’m
going to refer to the tutorial but hide my code.</p>
<div id="dealing-with-issues" class="section level2">
<h2>Dealing with issues</h2>
<p>It turns out that subsetting to the city borders put our empty lake
tracts back in! Let’s remove and tidy</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>Chicago.Census.sf <span class="ot">&lt;-</span> Chicago.Census.sf <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                     <span class="fu">st_transform</span>(<span class="dv">26916</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>                     <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>                     <span class="fu">st_make_valid</span>()</span></code></pre></div>
</div>
<div id="spatial-weights" class="section level2">
<h2>Spatial weights</h2>
<p>This tutorial shows you how to calculate a spatial weights matrix for
your data. <a
href="https://psu-spatial.github.io/Geog364-2025/Tutorial_SpatWeights.html"
class="uri">https://psu-spatial.github.io/Geog364-2025/Tutorial_SpatWeights.html</a>.</p>
<p>Remember to change the variable from ACS_country.geometry to whatever
you are using. I am using Chicago.city.sf.</p>
<p>Using the tutorial, I calculated a QUEENS 1ST ORDER weights
matrix</p>
<p>Because I had so many polygons, here’s how I plotted them:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># And plot</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))<span class="co"># big plot area</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="fu">plot</span>(Chicago.city.geometry, </span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>     <span class="at">border=</span><span class="st">&#39;darkcyan&#39;</span>,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>     <span class="at">lwd=</span>.<span class="dv">5</span>)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="fu">plot</span>(neighbor.queens, <span class="fu">st_coordinates</span>(Chicago_county.centroid), </span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>     <span class="at">col=</span><span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,.<span class="dv">4</span>), <span class="co"># transparent black</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>     <span class="at">lwd=</span>.<span class="dv">5</span>,          <span class="co"># thin lines</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span>.<span class="dv">1</span>, <span class="co"># tiny dots</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>     <span class="at">add=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="Tutorial_LISA_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
</div>
<div id="morans-i-rerun" class="section level2">
<h2>Moran’s I rerun</h2>
<p>I’m now going to see if one of my variables is auto-correlated - the
percentage of people earning over $75K.</p>
<p>To do this, I used the code in <a
href="https://psu-spatial.github.io/Geog364-2025/Tutorial_Moran.html"
class="uri">https://psu-spatial.github.io/Geog364-2025/Tutorial_Moran.html</a>
adjusting for my location and my variable name (percent.income.gt75)</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">names</span>(Chicago.Census.sf)</span></code></pre></div>
<pre><code>## [1] &quot;GEOID&quot;               &quot;income.gt75&quot;         &quot;NAME&quot;               
## [4] &quot;total_pop&quot;           &quot;Area&quot;                &quot;pop.density_km2&quot;    
## [7] &quot;percent.income.gt75&quot; &quot;geometry&quot;</code></pre>
<p><br></p>
<p>But I get an error! (note this is old code USE THE CODE IN THE
TUTORIAL) It says I have missing values in “x” AKA in my percentage
income column.</p>
<div class="figure">
<img src="index_images/pg_364Lab7_Regression_2021_fig5.png" alt="*There are missing values in your column of choice*" width="974" />
<p class="caption">
<em>There are missing values in your column of choice</em>
</p>
</div>
<p><br></p>
<p>Let me check:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">summary</span>(Chicago.Census.sf<span class="sc">$</span>percent.income.gt75)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA&#39;s 
## 0.00000 0.04773 0.11132 0.12894 0.19147 0.54485       5</code></pre>
<p>Yes - three polygons didn’t calculate properly. Let’s take a
look:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>Chicago.Census.sf[<span class="fu">is.na</span>(Chicago.Census.sf<span class="sc">$</span>percent.income.gt75)<span class="sc">==</span><span class="cn">TRUE</span>,]</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["GEOID"],"name":[1],"type":["chr"],"align":["left"]},{"label":["income.gt75"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["NAME"],"name":[3],"type":["chr"],"align":["left"]},{"label":["total_pop"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Area"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["pop.density_km2"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["percent.income.gt75"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["geometry"],"name":[8],"type":["s_POLYGO"],"align":["right"]}],"data":[{"1":"17097863006","2":"0","3":"Census Tract 8630.06, Lake County, Illinois","4":"0","5":"0.2074210","6":"0","7":"NA","8":"<s_POLYGO>","_rn_":"171"},{"1":"17031980100","2":"0","3":"Census Tract 9801, Cook County, Illinois","4":"0","5":"2.9821258","6":"0","7":"NA","8":"<s_POLYGO>","_rn_":"828"},{"1":"17197980000","2":"0","3":"Census Tract 9800, Will County, Illinois","4":"0","5":"74.2357113","6":"0","7":"NA","8":"<s_POLYGO>","_rn_":"1645"},{"1":"17031980000","2":"0","3":"Census Tract 9800, Cook County, Illinois","4":"0","5":"20.0414761","6":"0","7":"NA","8":"<s_POLYGO>","_rn_":"1899"},{"1":"17031381700","2":"0","3":"Census Tract 3817, Cook County, Illinois","4":"0","5":"0.1943134","6":"0","7":"NA","8":"<s_POLYGO>","_rn_":"1973"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p><br></p>
<p>It turns out there are OTHER census tracts which don’t have data (or
zero population). lets remove those and try again. I’m going to remove
ones with zero population density. Which means I need to recreate my
spatial weights matrix…</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># remove missing data</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>Chicago.Census.sf <span class="ot">&lt;-</span> Chicago.Census.sf[Chicago.Census.sf<span class="sc">$</span>pop.density_km2 <span class="sc">&gt;</span>  <span class="dv">0</span> , ]</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="co"># recalculate spatial weight</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>Chicago.city.geometry <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(Chicago.Census.sf)</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>neighbor.queens <span class="ot">&lt;-</span> <span class="fu">st_contiguity</span>(Chicago.city.geometry, <span class="at">queen=</span><span class="cn">TRUE</span>)</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>weights.queens <span class="ot">&lt;-</span> <span class="fu">st_weights</span>(neighbor.queens)</span></code></pre></div>
<p>Now, my moran’s plot works. As we have a lot of data, I also adjusted
the plotting to make the points smaller. This allows us to clearly see
any outliers.</p>
<p><img src="Tutorial_LISA_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>It looks very clustered.. (which agrees with the map I made). Let’s
do a test. I’ll let you interpret it based on your lecture notes (and
see the most recent discussion)</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="fu">moran.test</span>(Chicago.Census.sf<span class="sc">$</span>percent.income.gt75, </span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>           weights.queens.sp ,</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>            <span class="at">zero.policy =</span> T)    </span></code></pre></div>
<pre><code>## 
##  Moran I test under randomisation
## 
## data:  Chicago.Census.sf$percent.income.gt75  
## weights: weights.queens.sp    
## 
## Moran I statistic standard deviate = 59.684, p-value &lt; 2.2e-16
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##      0.7497117818     -0.0004980080      0.0001579947</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
