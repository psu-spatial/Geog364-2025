---
title: "Lab 5: Autocorrelation"
output:
  html_document:
    css: projectlab.css
    highlight: pygments
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
editor_options: 
  markdown: 
    wrap: sentence
---


```{r, include=FALSE,echo=FALSE, warning=FALSE, message=FALSE}
# NOTES
```



```{r, include=FALSE,echo=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(eval = TRUE, 
                      fig.show = "hide", 
                      message = FALSE, 
                      warning = FALSE)

# Libraries
library(tidyverse)
library(AER)
library(broom)
library(ggplot2)
library(kableExtra)
library(openintro)
library(readxl)
library(skimr)
library(sp)
library(sf)
library(plotly)
library(tmap)
library(viridis)
library(elevatr)
library(osmdata)

# Data
house  <- read_excel("./index_data/Lab03_house.xlsx")
rubric <- read_excel("./index_data/Table_LabRubric.xlsx")
house_sf <- st_as_sf(house,coords=c("Longitude","Latitude"),crs=4326)

```



------------------------------------------------------------------------

\

# Welcome to Lab 5!

**Aim of the lab**

In this guide you will learn how to:

 - Access and use census data in R 
 - Run hypothesis tests 
 - Assess and visuralise autocorrelation

This lab guide follows and supplements the material presented in the textbook [Spatial Autocorrelation in R](https://mgimond.github.io/Spatial/spatial-autocorrelation-in-r.html).

<p class="comment">

::: {#boxgreen}
**This is a TWO WEEK LAB** See [here](https://psu.instructure.com/courses/2396422/assignments/17585714) for assignment guidelines. You must submit an `.Rmd` file and its associated `.html` file. 
::: 

\

::: {#boxedtext}
\
**Getting help** 
\
 - Kiely (and often Dr G) will be present during your lab sessions. This is the easiest way to get help. \
 - Dr G has weekly office hours and genuinely enjoys helping with R, even if you feel stuck or overwhelmed. \
 - You may send a Canvas message to Kiely or Dr G (or if you are completely lost).\
 \
:::

\

------------------------------------------------------------------------

\

# Set-up. DON'T SKIP!

\

### Create a project & get the data

There are two options here depending on whether you are using R-studio on the website (posit cloud) or your own computer (R-Desktop). If you are using a lab computer choose the R-Desktop route.

#### Option 1. Posit Cloud Website Users


<details>

<summary>Task 1. Create a project for Lab 5 (expand for instructions)</summary>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T5_ProjectsPositCloud.html" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

<br>

</details>

::: small-gap
:::


<details>

<summary>Task 2. Install more packages (expand for instructions)</summary>

<br>

Unfortunately on the website you need to install your packages each time.<br>Go to to the packages tab, click install to get to the app-store and download/install these packages:

-   `readxl`
-   `viridis`
-   `ggstatsplot`
-   `terra`
-   `tigris`
-   `tidyverse`
-   `dplyr`
-   `tmap`
-   `elevatr`
-   `osmdata`
-   `ggplot2`
-   `ggthemes`
-   `RColorBrewer`
-   `plotly`
-   `cols4all`
-   `shinyjs`


We will also need a package called sf, which runs a lot of the spatial commands in R. Unfortunately, posit cloud sometimes has a few technical issues with sf, so you will need to run a special command.

IN THE CONSOLE, run these two commands.

```{r,eval=FALSE}
install.packages("remotes")
remotes::install_github(repo = "r-spatial/sf", ref = "93a25fd8e2f5c6af7c080f92141cb2b765a04a84")
```



T6_Packages.html
<br>*Reminder: [Tutorial: Packages
cheatsheet](https://psu-spatial.github.io/Stat462-2025/T6_Packages.html)*.

</details>

#### Option 2. R-Desktop Users

<details>

<summary>Task 1. Create a project for Lab 5</summary>

<br>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T5_ProjectsRDesktop.html" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

</details>

::: small-gap
:::

<br>

### Set-up your Lab 5 report

You are welcome to use/edit the template you made in previous labs. If you are unsure what I mean by that, follow these instructions.

<details>

<summary>Task. Create your RMarkdown file - expand & look at Tutorial 4B and 4C</summary>

<br>

::: collapsible-content
<iframe src="https://hgreatrex.github.io/Geog364_2024/pg_Tut4_markdown.html#Tutorial_4B:_Creating_a_markdown_document" style="width: 100%; height: 700px; border: none;">
</iframe>
:::


</details>

::: small-gap
:::



<details>

<summary>Task. Edit your YAML code & ADD A NEW THEME</summary>

<br>

Lets use similar options to Lab 4.  Remember YAML code is annoying to edit, because here, *spaces really do matter*. Everything has to be perfect or it won't knit.

 - **Select everything in my code chunk here and replace your YAML with this (remember the --- on line 1 and at the end).**

 - Now edit the author name to your own.  If you wonder what Sys.Date() is, don't touch it - it automatically gives you the current date.
 
 - Now change your theme to your favourite one of these - you can see what it looks like by pressing knit. Note, DO NOT put quote marks around the theme name.
   - bootstrap
   - cerulean
   - cosmo
   - darkly
   - flatly
   - journal
   - lumen
   - paper
   - readable
   - sandstone
   - simplex
   - spacelab
   - united
   - yeti
 


```{r,eval=FALSE}

#---------------------------------------------------------
# NOTE, Your theme does NOT have quote marks around it 
#---------------------------------------------------------
---
title: "GEOG-364 - Lab 5"
author: "hlg5155"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: yes
    number_sections: yes
    theme: lumen
    df_print: paged
---
  
  
```



</details>

::: small-gap
:::


<details>

<summary>Task. Delete the existing text and create/run your library code chunk</summary>

<br>

 - Click on your lab script (the Rmd file) and delete all the 'welcome text' after line 11.<br>Press enter a few times and make a new level-1 heading called `Set Up`.<br>

 - We should have all the packages we need installed, but we need to open them. Make a new code chunk containing this code.<br>

```{r,message=FALSE,warning=FALSE, eval=FALSE}
library(readxl)
library(tidyverse)
library(dplyr)
library(terra)
library(sf)
library(tmap)
library(elevatr)
library(osmdata)
library(ggstatsplot)
library(ggplot2)
library(ggthemes)
library(viridis)
library(RColorBrewer)
library(plotly)
library(units)
```

<br>

 - Press the green arrow on the right of the code chunk to run the code inside it. You will see a load of "loading text" telling your details about the packages you just loaded.<br><br> Press the green arrow AGAIN. The text should disappear unless there is an error.<br>

-   Note, remember to run this code chunk EVERY TIME your start R-Studio (in the same way you need to click on an app on your phone before you can use it). <br>

You might need additional libraries as you work through the lab. If so, add them in this code chunk AND REMEMBER TO RERUN. If you see a little yellow bar at the top asking you to install them,click yes!

<br>

</details>

::: small-gap
:::

<details>

<summary>Task. Add warning=FALSE and message=FALSE to your library code chunk.
</summary>


<br>

 - Expand here for a tutorial.

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T7_Markdown_4bCodeChunkOptions.html" style="width: 100%; height: 700px; border: none;">

</iframe>
:::

</details>

::: small-gap
:::

### Check your progress

Your lab script should now look similar this, but with your theme and YAML options of choice (you might have a few different libraries than in my screenshot). You should also be able to knit it successfully. If not, go back and do the previous sections!

<br>

![](index_images/pg_364Lab2_Summary_2021_fig2.png)

<br>

<br>



\

------------------------------------------------------------------------

\


# Accessing US-Census Data

The tutorial below will show you how to download and use data from the US census and
American Community survey. Read the lab instructions first, then us the tutorial to help you do it.



1. Make a  new section & explain ACS

Make a new section in your lab script called US-Census data

<br>

Using this page or google, read about the American Community Survey - 
https://www.census.gov/programs-surveys/acs/about.html

*Now, Explain what the US-Census American Community survey is and why it's a useful dataset*. Make sure to include what the object of analysis is and its boundaries in time (e.g. does one survey represent all of US history?)

<br>

2. Read through the tutorial below

As you read - know that, the tutorial is focused on Maine and New Hampshire. YOU WILL BE FOCUSED ON IOWA. Looking at the list of variables, choose one or two additional variables that interest you. For example, past students have looked at water, poverty (access to sanitation), access to broadband, demographics and crime etc. <br>


<details>

<summary>Expand for tutorial - Census data</summary>

<br>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Geog364-2025/Tutorial_CensusData" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

</details>

::: small-gap
:::


3. Download census data using the tutorial. <br>

Use the tutorial code to download county level American Community Survey for *IOWA*, including:

 - housevalue ("B25075_001")
 - total_pop ("B05012_001") 
 - total_house ("B25001_001")
 - med.income  ("B19013_001") 
 - AND a few variables of your own (see previous step)

<br>

*REMEMBER THAT YOU NEED TO GET YOUR API KEY FIRST FROM THE START OF THE TUTORIAL, AND IT WON'T WORK UNTIL YOU HAVE FULLY RESTARTED R-STUDIO.*

<br>


4.  Make 3 maps from this data that show something interesting about Iowa. 

Write a few sentences under each one interpreting your results e.g. look at google maps, why are certain counties/high or low. <br> Bonus marks for something that's genuinely interesting, rather than just two random variables you decided on. <br><br> If you want to continue to improve your tmap chloropleths.
    <https://rpubs.com/erikaaldisa/choroplethmapping> 
    
<br>

5.  The Modifiable Areal Map Problem MAUP

WE WILL COVER THIS ON WEDNESDAY Explain the modifiable areal map problem and both the shape and zone
    effects. Write any impacts of MAUP that you see in your analyses of Iowa and your reasoning. 
    
<br>

6.  Chloropleths

Using google, explain what a chloropleth map is and why MAUP is a problem.

<br>

7.  Use the best practice for chloropleths

Look at the best practice for chloropleths <https://blog.datawrapper.de/choroplethmaps/> and make a new version of one of your plots with at least one improvement, explaining what you did. If you can't get it working, you can get most of the marks for explaining what you WANTED to do.


\

------------------------------------------------------------------------

\

# Moran's I & Autocorrelation

## Autocorrelation basics

Now we will focus on autocorrelation. 

8. Make a new section 

Make a new section in your lab script called Autocorrelation.  In this section, I will leave it up to you to make clear sub-headings to make it easy for grading. 

<br>

9. Explain in your report:

(see Monday's lecture and reading)

 - What is spatial autocorrelation and why is it important?
 - What is positive/negative/zero autocorrelation and what patterns/processes would you expect to see.
 - For one of the maps you made above, state which map you chose and explain whether you think you see positive/negative/zero autocorrelation (and your reasoning)
 - Why will total population look much more clustered than population density?

<br>

## Spatial weights matrices

To understand the autocorrelation, we first need to define neighbourhood.


10. Read through the tutorial below

<details>

<summary>Expand for tutorial - Spatial weights</summary>

<br>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Geog364-2025/Tutorial_SpatWeights.html" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

</details>

::: small-gap
:::

<br>


11. Calculate the spatial weights

Now use the tutorial above to calculate and plot these neighbours and spatial weights matrix for your Iowa dataset. 
 -  QUEENS 1st order 
 -  ROOKS 2nd order

<br>

13. Explain what you did

Below your code, briefly explain the difference between nearest neighbour, Rook’s, and Queen’s spatial weights matrices. Your answer should describe how each defines adjacency and what kinds of spatial relationships they capture.

14. Are the Hawkeyes neighbours?

The Iowa Hawkeyes are based in Iowa City, Iowa (look up the county if needed).
Your friend lives in Black Hawk County, Iowa. Using R code from the tutorial, determine whether Black Hawk County is a Rook’s 2nd-order neighbour of Iowa City’s county.
Show your code and output.


\

## Moran's Scatterplots and Moran's I




## Moran's hypothesis test







# Submitting your Lab

Remember to save your work throughout and to spell check your writing (next to the save button). Now, press the knit button again. If you have not made any mistakes in the code then R should create a html file in your lab3 folder, complete with a very recent time-stamp.

<br>

### If you are on posit cloud:

You can download each of your .RmD and html files by:

 - Clicking on the little box next to the Rmd in the Files tab, then going to the little blue cogwheel (might need to make your Rstudio full screen) and clicking export.<br>

```{r, Lab2FigDownload, echo=FALSE,fig.align='center',out.width="90%"}
knitr::include_graphics('./index_images/im_T2_Download.png')
```


 - Repeat the process exactly for the html file underneath it (e,g, just have the html clicked.)<br>
 
 - Now go to Canvas and submit BOTH your html and your .Rmd file in Lab 5.


<br>

### Posit desktop

 - Go to your Lab 5 folder,  In that folder, double click on the html file. This will open it in your browser. CHECK THAT THIS IS WHAT YOU WANT TO SUBMIT <br>

- Now go to Canvas and submit BOTH your html and your .Rmd file in Lab 5.<br>

```{r, echo=FALSE}
knitr::include_graphics("./index_images/pg_364Lab1_Basics_2021_fig1.png")
```

<br>

------------------------------------------------------------------------

\

# Grading rubric

## Lab 5

# CHECK THIS BEFORE YOU SUBMIT!

People who use this section get better grades...

## Predict your grade


# Grading rubric

-   **Submitting Rmd & HTML (15 pts)**
    -   20: Both .Rmd and .html submitted
    -   10:Only one file submitted

<br>

-   **General style (10 pts)**
    -   10: Great style: \
        *Easy to find answers; no library-loading printouts; no code warnings; YAML works*
    -   8: Minor issues: \
        *Occasional hard-to-find answers; library-loading text printed; missing table of contents*
    -   6: Major issues: \
        \*Hard to find answers; multiple code issues

<br>

-   **General writing (10 pts)** <br> Your code and document is neat and easy to read. LOOK AT YOUR HTML FILE
IN YOUR WEB-BROWSER BEFORE YOU SUBMIT. There is also a spell check next to the save button. You have written your answers below the relevant code chunk in full sentences in a way that is easy to find and grade. For example, you have written in full sentences, it is clear what your answers are referring to.
    -   10: Great writing: \
        *Full sentences, you have written up what your code does in the report. You have used units where appropriate.*
    -   8: Minor issues: \
        *To complete*
    -   6: Major issues: \
        *To complete*


-  **US-Census Data** - 25 MARKS**

    -   Download the census data & make/explain maps for Iowa [10]
    
    -   Your MAUP answers [10]

    -   Best practice [5]

To come

## Overall

Overall, here is what your lab should correspond to:

```{r, echo=FALSE}
knitr::kable(rubric) %>%   
  kable_classic_2() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"))

```

And..
finished!