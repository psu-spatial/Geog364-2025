---
title: "Lab 3:"
output:
  html_document:
    css: projectlab.css
    highlight: pygments
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 4
editor_options: 
  markdown: 
    wrap: sentence
---


```{r, include=FALSE,echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      fig.show = "hide", 
                      message = FALSE, 
                      warning = FALSE)

# Libraries
library(tidyverse)
library(AER)
library(broom)
library(ggplot2)
library(kableExtra)
library(openintro)
library(readxl)
library(skimr)
library(sp)
library(sf)
library(plotly)
library(tmap)
library(viridis)

# Data
house  <- read_excel("./index_data/Lab03_house.xlsx")
rubric <- read_excel("./index_data/Table_LabRubric.xlsx")
```



------------------------------------------------------------------------

\

# Welcome to Lab 3!

**Aim of the lab**

 - Practice setting up and managing a structured RStudio project using spatial and non-spatial data

 - Use exploratory data analysis (EDA) to summarise and interpret real-world housing data for a non-technical audience

 - Define and explain core data concepts: object of analysis, variables (with units), population, sampling frame, and representativeness

 - Convert tabular data into a spatial format using coordinates, and describe spatial attributes such as data type and spatial fallacy risks

 - Create both quick and professional-quality spatial visualisations using tmap

 - Develop confidence in communicating data insights through clear language, maps, and plots tailored to an end user (your friend)


\

::: {#boxedtext}
\
**Getting help** 
\
 - Kiely (and often Dr G) will be present during your lab sessions. This is the easiest way to get help. \
 - There is a Piazza discussion board. Kiely will explain more in this week‚Äôs lab and will check it at least once a day. \
 - Dr G has weekly office hours and genuinely enjoys helping with R, even if you feel stuck or overwhelmed. \
 - If you have posted on Piazza and received no response after 24 hours, you may send a Canvas message to Kiely or Dr G (or if you are completely lost).\
 \
:::

\

------------------------------------------------------------------------

\

# Set-up. DON'T SKIP!

\

### Create a project & get the data

There are two options here depending on whether you are using R-studio on the website (posit cloud) or your own computer (R-Desktop). If you are using a lab computerm choose the R-Desktop route.

#### Option 1. Posit Cloud Website Users

<details>

<summary>Task 1. Get the data from Canvas</summary>

<br>

Go to the Lab 3 Canvas page and download the dataset `Lab03_house.xlsx` <br>

</details>

::: small-gap
:::

<details>

<summary>Task 2. Create a project for Lab 3 (expand for instructions)</summary>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T5_ProjectsPositCloud.html" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

<br>

</details>

::: small-gap
:::

<details>

<summary>Task 3. Upload your dataset to the website. (expand for reminder)</summary>

![](index_images/im_T2_Upload.png)


</details>

::: small-gap
:::

<details>

<summary>Task 4. Install more packages (expand for instructions)</summary>

<br>

Unfortunately on the website you need to install your packages each time.<br>Go to to the packages tab, click install to get to the app-store and download/install these packages:

-   `readxl`
-   `viridis`
-   `ggstatsplot`
-   `terra`
-   `tigris`
-   `tidyverse`
-   `dplyr`
-   `tmap`
-   `elevatr`
-   `osmdata`


We will also need a package called sf, which runs a lot of the spatial commands in R. Unfortunately, posit cloud sometimes has a few technical issues with sf, so you will need to run a special command.

IN THE CONSOLE, run these two commands.

```{r,eval=FALSE}
install.packages("remotes")
remotes::install_github(repo = "r-spatial/sf", ref = "93a25fd8e2f5c6af7c080f92141cb2b765a04a84")
```



T6_Packages.html
<br>*Reminder: [Tutorial: Packages
cheatsheet](https://psu-spatial.github.io/Stat462-2025/T6_Packages.html)*.

</details>

#### Option 2. R-Desktop Users

<details>

<summary>Task 1. Create a project for Lab 3</summary>

<br>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T5_ProjectsRDesktop.html" style="width: 100%; height: 700px; border: none;">
</iframe>
:::

</details>

::: small-gap
:::

<details>

<summary>Task 2. Get the data & **put in your Lab 3 folder**</summary>

<br>

Go to the Lab 3 Canvas page and download the dataset `Lab03_house.xlsx`. **Put it in your lab 3 folder.**

</details>

::: small-gap
:::

<details>

<summary>Task 3. Install some packages</summary>

<br>

We need to install some more packages.<br>Go to to the packages tab, click install to get to the app-store and download/install these packages. If your computer says its missing a package later on, install anything it suggests.

-   `elevatr`
-   `osmdata`

Remember DO NOT put `install.packages()` into your lab-script - copy and paste it into thee console.

<br>*Reminder: [Tutorial: Packages
cheatsheet](https://hgreatrex.github.io/Geog364_2024/pg_Tut3_basics.html#Tutorial_3G:_Packages)*.

</details>

<br>

### Set-up your Lab 3 report

You are welcome to use/edit the template you made in lab 2. If you are unsure what I mean by that, follow these instructions.

<details>

<summary>Task. Create your RMarkdown file - expand & look at Tutorial 4B and 4C</summary>

<br>

::: collapsible-content
<iframe src="https://hgreatrex.github.io/Geog364_2024/pg_Tut4_markdown.html#Tutorial_4B:_Creating_a_markdown_document" style="width: 100%; height: 700px; border: none;">
</iframe>
:::


</details>

::: small-gap
:::



<details>

<summary>Task. Edit your YAML code</summary>

<br>

Lets use similar options to Lab 2, although you could try a different theme.  Remember YAML code is annoying to edit, because here, *spaces really do matter*. Everything has to be perfect or it won't knit.

**Select everything in my code chunk here and replace your YAML with this (remember the --- on line 1 and at the end).**

Now edit the author name to your own.  If you wonder what Sys.Date() is, don't touch it - it automatically gives you the current date.

```{r,eval=FALSE}

---
title: "GEOG-364 - Lab 3"
author: "hlg5155"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: yes
    number_sections: yes
    theme: lumen
    df_print: paged
---
  
  
```





</details>

::: small-gap
:::

<details>

<summary>Task. Change the theme and knit</summary>

<br>

In the YAML code, change the theme to any one of your choice that isn't not lumen (see here to view available themes -
<https://bootswatch.com/>.). <br>

Some might not work, but these are likely to: ‚Äúdefault‚Äù, ‚Äúbootstrap‚Äù, ‚Äúcerulean‚Äù, ‚Äúcosmo‚Äù, ‚Äúdarkly‚Äù, ‚Äúflatly‚Äù, ‚Äújournal‚Äù, ‚Äúlumen‚Äù, ‚Äúpaper‚Äù, ‚Äúreadable‚Äù, ‚Äúsandstone‚Äù, ‚Äúsimplex‚Äù, ‚Äúspacelab‚Äù, ‚Äúunited‚Äù, ‚Äúyeti‚Äù.

</details>

::: small-gap
:::

<details>

<summary>Task. Clean the file and create/run your library code chunk</summary>

<br>

 - Click on your lab script (the Rmd file) and delete all the 'welcome text' after line 11.<br>Press enter a few times and make a new level-1 heading called `Set Up`.<br>

 - We should have all the packages we need installed, but we need to open them. Make a new code chunk containing this code.<br>

```{r,message=FALSE,warning=FALSE, eval=FALSE}
library(readxl)
library(tidyverse)
library(dplyr)
library(terra)
library(sf)
library(tmap)
library(elevatr)
library(osmdata)
library(ggstatsplot)
library(ggplot2)
library(hrbrthemes)
library(ggthemes)
library(viridis)
library(RColorBrewer)
library(plotly)
```

<br>

 - Press the green arrow on the right of the code chunk to run the code inside it. You will see a load of "loading text" telling your details about the packages you just loaded.<br><br> Press the green arrow AGAIN. The text should disappear unless there is an error.<br>

-   Note, remember to run this code chunk EVERY TIME your start R-Studio (in the same way you need to click on an app on your phone before you can use it). <br>

<br>

</details>

::: small-gap
:::

<details>

<summary>Task. Add warning=FALSE and message=FALSE to your library code chunk.
</summary>


<br>

 - Expand here for a tutorial.

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/T7_Markdown_4bCodeChunkOptions.html" style="width: 100%; height: 700px; border: none;">

</iframe>
:::

</details>

::: small-gap
:::

### Check your progress

Your lab script should now look similar this, but with your theme and YAML options of choice (you might have a few different libraries than in my screenshot). You should also be able to knit it successfully. If not, go back and do the previous sections!

<br>

![](index_images/pg_364Lab2_Summary_2021_fig2.png)

<br>



\

------------------------------------------------------------------------

\

# WEEK 1

The aim of EVERY LAB is to get comfortable writing up analyses of a complex dataset for a specific person or user. The modelling steps may be similar across labs, but the topic and context will vary‚Äîso you'll need to think carefully about what matters in each case.

<br>

## Moving to Taiwan

Your friend is about to move to Sindian District in New Taipei City, Taiwan. They‚Äôre thinking about buying a house‚Äîand they‚Äôve asked for your help figuring out what affects house prices in the area. This matters a lot because housing costs have soared in recent years: [Who can afford to live in Taipei?](https://english.cw.com.tw/article/article.action?id=3416)

Luckily, you‚Äôve found a dataset, `Lab03_house.xlsx`, to help. This is real-life data, described in detail here: [UCI Real Estate Valuation Data Set](https://archive.ics.uci.edu/dataset/477/real+estate+valuation+data+set)

<br> 
#### *Your Goal*  
To understand which factors influence house prices in Sindian District, New Taipei City, Taiwan, and communicate your results to a non-technical reader.

**You are writing the rest of this report for your friend!**  
Make sure to explain your findings clearly. Your friend doesn‚Äôt study data science or geography, so use language that they can understand and explain any jargon.

### Instructions

#### Basics

\

1. In your report, create a new Level 1 heading called `House Prices`. 

Remember that you can click Visual mode and use the menu to do this, or put a single # at the front.

\

2. Check you are running your project

Before doing anything else, make sure:

 - You are running this lab inside your Lab 3 RStudio project
 - `Lab03_house.xlsx` is saved/uploaded in your *Lab 3 project folder* next to your lab report.

If not, go back to the **setup section** of this lab before continuing. The code below will not work until your project and files are properly set up. Also remmeber that you need to open your lab 3 project every time you reopen R-studio. 


\

2. Read in the data using read_excel() 

Once you‚Äôre ready, make a code chunk and write a line of code that uses `read_excel(FILENAME)` to read the Excel file into R, and **assign/save it a variable called house**.

<details>

<summary>Expand here for a tutorial on how to do this - scroll down to section 1.4</summary>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/in_T07_ReadingInData.html#14_Reading_in_excel_files" style="width: 95%; height: 600px; border: none;">

</iframe>
:::

</details>

::: small-gap
:::

::: {#boxgreen}
**üîç Reminder**
This command will only work if you have already run the library code chunk that loads the readxl package - and you need to re-run the library code chunk every time you open R.
:::

\


4. Summarise the data for your friend using code, plots and words

Your goal here is to use R summary commands and plots, along with the background reading, to explore and describe your dataset for your friend. You want to help them understand what yor does (and doesn't) include, and to explain what it can tell them about house prices in New Taipei City.

-   **If you haven't already, start by reading the dataset description here: [Real estate valuation data set ‚Äì UCI](https://archive.ics.uci.edu/ml/datasets/Real+estate+valuation+data+set)**

-   **In your report, use command like `summary()` OR `skim()` (or others!) to explore the house data. See the tutorials below.**

-   **Underneath the code chunk in your reports, write a short section that describes the dataset in clear language for your friend. This should must include:** <br>

    -   The object of analysis: \
        What does each row in the dataset represent? <br><br>
    -   A list of the variables AND THEIR UNITS: \
        Briefly describe each column in the data, including what it measures and the unit (e.g., meters, years). Remember the dataset description website... <br><br>
    -   The 'strict population' (sampling frame): \
        If you were being really strict, what does this sample cover.<br><br>
    -   A reasonable, justifiable target population: \
        Based on this sample, what group do you think the data can reasonably be used to represent? <br><br>
    -   A clear, professional-looking histogram of house prices in a new code chunk:\
        See the tutorials below <br><br>
    -   Summary statistics of the variables, explained in context for your friend:\
        Choose a few key variables and explain what the numbers in the summary mean for your friend. For example, can they walk to the station from most places? Are most of the homes near shops? What range of prices are there? <br><br>
    -   Note any data limitations:\ For example - spatio-temporal coverage? sample bias? missing variables? other things? 
    -   Overall, summarise if you think the sample is representative of your friend's needs.


<details>

<summary>Expand here for a tutorial on how to summarise data. Click section 2.3</summary>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/CH3_EDA.html#23_Summary_Statistics" style="width: 95%; height: 600px; border: none;">
</iframe>
:::

</details>

::: small-gap
:::


<details>

<summary>Expand here for a tutorial on how to make histograms. Click section 2</summary>

::: collapsible-content
<iframe src="https://psu-spatial.github.io/Stat462-2025/in_T11_Plots.html#21_Set-up" style="width: 95%; height: 600px; border: none;">

</iframe>
:::

</details>

::: small-gap
:::


#### Making spatial data

\

5. Make the data "spatial".

Unlike standard statistics, our data also has spatial characteristics.  At the moment, R doesn't 'understand' that the data is spatial. In this section we force R to view the data as spatial.

 - Make a new heading called spatial analysis in your report <br><br>
 
 - First, we need to know the COLUMN NAMES of the x and y coordinates (case sensitive). The easiest way to get these is to make a new code chunk and run this command. 
 
 
```{r, eval=FALSE}
names(house)
```

<br>

- We can now use the st_as_sf() command to make a spatial version of the data. Because we're using the sf package to do this, I have named the resulting dataset house_sf(). Make a new code chunk, copy in the code below and change "X_COLUMN_NAME" and "Y_COLUMN_NAME" to the appropriate column name from your data.


```{r, eval=FALSE}
# Hint, the y direction is Latitude..
house_sf <- st_as_sf(house,coords=c("X_COLUMN_NAME","Y_COLUMN_NAME"),crs=4326)
```


6. Explain the spatial attributes

Below this code, answer these questions 

 - Explain if your data is being represented as a vector (and what type) or raster. Discuss if this is true in real life and if this representation is appropriate for the reason you need the data. 

 - Do you need to worry about the locational fallacy in this case? Explain your answer to your friend.


\

7. Make some quick maps.

There is a quick way to check your data was read in correctly.  Make a map!  The quickest way to do this is using the qtm command. 

- Make a new section called maps

- Try each of these commands in a new code chunk for each. They should show you some nice maps over Taiwan.  

- If your data looks weird, you probably mixed up long and lat. Go back to the previous step, change it and rerun - or ask Kiely!


```{r, eval=FALSE}
#Set the mode to "view" for an interactive map
tmap_mode("view")

# Make a "quick thematic map" of the house data
qtm(house_sf)
```

You can also have a look at variables. For example:

```{r,eval=FALSE}
# A map where the colors are linked to house price.
qtm(house_sf,fill="House.Price")
```

If you hate the interactive-ness, change tm_mode to "plot" (but you lose the background map).  

```{r,eval=FALSE}
# Change the mode to "plot" for a static map
tmap_mode("plot")

# Re-run the same qtm() command to produce a static version
qtm(house_sf,fill="House.Price")
```

We will make a better static map below!

\

#### Making better maps

QTM is great for quick looks, but in terms of making professional output, it can be hard to get it to look really good.  So here's how to make professional looking maps of your output that you can use in a pdf or printout. 

The first thing to know is that tmap is currently going through a HUGE revamp.  Code that used to work for "version 3" is being switched to "version 4".  I think I have all of it, but if you see warning messages, you can either ignore them or ask chatgpt what the updated code is.

This is a very detailed guide. https://tmap.geocompx.org/nutshell


7. Make a better map in tmap

We build maps in LAYERS. First, we choose the dataset we want, then we choose how to represent it (e.g. dots for points, raster for grids, polygons for areas), then add overall map layers like legends or basemaps. We connect each layer with with a +.

 - Make a new code chunk and copy in/run this code.

```{r, eval=FALSE}

# A better static map

tmap_mode("plot")
price_scale <- tm_scale_intervals(values = "Blues", style = "jenks")
tm_shape(house_sf) +
  tm_dots(
    fill        = "House.Price",
    size        = 0.4,
    fill.scale  = price_scale,
    fill.legend  = tm_legend("House Price")) +
tm_basemap(server = "CartoDB.Positron")

```




# WEEK 2 TO COME......

In week 2, you will focus on downloading other new map layers, like elevation and Open Street Map data, along with some basic statistical analysis.


\

------------------------------------------------------------------------

\

# What to submit?

Nothing yet!  

<br>


\

------------------------------------------------------------------------

\

# Grading rubric

## Overall

Overall, here is what your lab should correspond to:

```{r, echo=FALSE}
knitr::kable(rubric) %>%   
  kable_classic_2() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"))

```

And..
finished!
